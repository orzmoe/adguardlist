name: sync-adrules

on:
  workflow_dispatch:
  watch:
    types: [started]
  schedule:
    - cron: '21 */3 * * *'  # æ¯3å°æ—¶è¿è¡Œä¸€æ¬¡
  push:
    paths:
      - 'setting/rules.txt'  # å½“è§„åˆ™æºæ–‡ä»¶æ›´æ–°æ—¶è‡ªåŠ¨è¿è¡Œ

permissions:
  contents: write

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # è®¾ç½®è¶…æ—¶æ—¶é—´
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4  # å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4  # å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
        with:
          node-version: '20'  # å‡çº§åˆ° Node.js 20 LTS

      - name: Install dependencies
        run: |
          npm install -g @adguard/hostlist-compiler@latest

      - name: Set environment variables
        run: |
          echo "RELEASE_NAME=Released on $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "TAG_NAME=$(date '+%Y%m%d%H%M')" >> $GITHUB_ENV
          echo "BUILD_TIME=$(date -Iseconds)" >> $GITHUB_ENV
          echo "RULES_COUNT=0" >> $GITHUB_ENV

      - name: Download and merge rules
        id: download
        run: |
          set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p temp_downloads publish rules
          
          # æ¸…ç†æ—§æ–‡ä»¶
          rm -f ./out*.txt ./temp_*.txt ./merged_*.txt
          
          echo "ğŸš€ å¼€å§‹ä¸‹è½½è§„åˆ™æ–‡ä»¶..."
          download_count=0
          success_count=0
          failed_urls=()
          
          # å¹¶è¡Œä¸‹è½½ä¼˜åŒ–ï¼šåˆ†æ‰¹å¤„ç†
          batch_size=5
          temp_files=()
          
          while IFS= read -r url; do
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            if [[ -z "$url" || "$url" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            
            url=$(echo "$url" | tr -d '\r\n ')  # æ¸…ç†URL
            filename="temp_downloads/rules_${download_count}.txt"
            temp_files+=("$filename")
            
            echo "ğŸ“¥ å¼€å§‹ä¸‹è½½: $url"
            
            # ä½¿ç”¨æ›´å¥å£®çš„ä¸‹è½½å‚æ•°
            if curl -sS -L --connect-timeout 10 --max-time 30 \
                    --retry 3 --retry-delay 2 \
                    -H "User-Agent: Mozilla/5.0 (compatible; AdRulesBot/1.0)" \
                    "$url" -o "$filename"; then
              
              # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
              if [[ -f "$filename" && -s "$filename" ]]; then
                file_size=$(wc -c < "$filename")
                echo "âœ… ä¸‹è½½æˆåŠŸ: $url (${file_size} bytes)"
                ((success_count++))
              else
                echo "âŒ æ–‡ä»¶ä¸ºç©º: $url"
                rm -f "$filename"
                failed_urls+=("$url")
              fi
            else
              echo "âŒ ä¸‹è½½å¤±è´¥: $url"
              rm -f "$filename"
              failed_urls+=("$url")
            fi
            
            ((download_count++))
            
            # æ§åˆ¶å¹¶å‘
            if (( download_count % batch_size == 0 )); then
              sleep 1
            fi
          done < "./setting/rules.txt"
          
          echo "ğŸ“Š ä¸‹è½½ç»Ÿè®¡: æˆåŠŸ $success_count/$download_count"
          
          # æŠ¥å‘Šå¤±è´¥çš„URL
          if [[ ${#failed_urls[@]} -gt 0 ]]; then
            echo "âš ï¸  ä»¥ä¸‹ ${#failed_urls[@]} ä¸ªURLä¸‹è½½å¤±è´¥:"
            printf '  - %s\n' "${failed_urls[@]}"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æˆåŠŸä¸‹è½½çš„æ–‡ä»¶
          downloaded_files=(temp_downloads/*.txt)
          if [[ ! -f "${downloaded_files[0]}" ]]; then
            echo "âŒ é”™è¯¯: æ²¡æœ‰æˆåŠŸä¸‹è½½ä»»ä½•è§„åˆ™æ–‡ä»¶"
            exit 1
          fi
          
          # åˆå¹¶æ‰€æœ‰ä¸‹è½½çš„è§„åˆ™æ–‡ä»¶
          echo "ğŸ”„ åˆå¹¶è§„åˆ™æ–‡ä»¶..."
          cat temp_downloads/*.txt > merged_rules.txt
          
          merged_size=$(wc -c < merged_rules.txt)
          echo "âœ… åˆå¹¶å®Œæˆ: $(ls temp_downloads/*.txt | wc -l) ä¸ªæ–‡ä»¶, æ€»å¤§å° ${merged_size} bytes"
          
          # ä¿å­˜ç»Ÿè®¡ä¿¡æ¯
          echo "SUCCESS_COUNT=$success_count" >> $GITHUB_ENV
          echo "TOTAL_COUNT=$download_count" >> $GITHUB_ENV
          echo "FAILED_COUNT=${#failed_urls[@]}" >> $GITHUB_ENV

      - name: Compile rules
        run: |
          set -e
          
          echo "âš™ï¸  ç¼–è¯‘è§„åˆ™..."
          
          # ç¼–è¯‘è§„åˆ™
          if ! hostlist-compiler -i "merged_rules.txt" -o "temp_rules.txt"; then
            echo "âŒ è§„åˆ™ç¼–è¯‘å¤±è´¥"
            exit 1
          fi
          
          # éªŒè¯ç¼–è¯‘ç»“æœ
          if [[ ! -f "temp_rules.txt" ]]; then
            echo "âŒ ç¼–è¯‘è¾“å‡ºæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # ç»Ÿè®¡è§„åˆ™æ•°é‡ï¼ˆæ’é™¤æ³¨é‡Šå’Œç©ºè¡Œï¼‰
          rules_count=$(grep -c -v -E '^[[:space:]]*(!|$)' temp_rules.txt || echo "0")
          echo "ğŸ“ ç¼–è¯‘å®Œæˆï¼ŒåŒ…å« $rules_count æ¡æœ‰æ•ˆè§„åˆ™"
          
          echo "RULES_COUNT=$rules_count" >> $GITHUB_ENV

      - name: Generate output file
        run: |
          set -e
          
          echo "ğŸ“ ç”Ÿæˆæœ€ç»ˆè¾“å‡ºæ–‡ä»¶..."
          
          {
            echo "# Title: 5whys Adguard Home Rules List (Use with a lot of false rejects)"
            echo "# Version: $(date '+%Y%m%d%H%M')"
            echo "# Generated: $BUILD_TIME"
            echo "# Expires: 12 hours"
            echo "# Total sources: $TOTAL_COUNT (Success: $SUCCESS_COUNT, Failed: $FAILED_COUNT)"
            echo "# Total rules: $RULES_COUNT"
            echo "# Homepage: https://github.com/${{ github.repository }}"
            echo "#"
            echo "# Source URLs:"
            
            while IFS= read -r line; do 
              if [[ -n "$line" && ! "$line" =~ ^[[:space:]]*# ]]; then
                echo "# - $line"
              fi
            done < "./setting/rules.txt"
            
            echo "#"
            echo "####################################################################################"
            echo
            
            # æ·»åŠ ç¼–è¯‘åçš„è§„åˆ™å†…å®¹
            cat temp_rules.txt
            
            echo
            echo "####################################################################################"
            echo "# Generated by GitHub Actions on $BUILD_TIME"
            echo "# Repository: https://github.com/${{ github.repository }}"
            echo "####################################################################################"
            
          } > output.txt
          
          # éªŒè¯è¾“å‡ºæ–‡ä»¶
          output_size=$(wc -c < output.txt)
          echo "âœ… è¾“å‡ºæ–‡ä»¶ç”Ÿæˆå®Œæˆ: ${output_size} bytes"
          
          # æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ
          echo "ğŸ“‹ æ–‡ä»¶å‰10è¡Œé¢„è§ˆ:"
          head -10 output.txt

      - name: Prepare release files
        run: |
          # å¤åˆ¶æ–‡ä»¶åˆ°å‘å¸ƒç›®å½•
          cp output.txt publish/
          cp output.txt rules/
          
          # ç”Ÿæˆé¢å¤–çš„æ ¼å¼
          cp output.txt publish/adguard-rules.txt
          cp output.txt rules/adguard-rules.txt
          
          echo "ğŸ“¦ å‘å¸ƒæ–‡ä»¶å‡†å¤‡å®Œæˆ"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ env.RELEASE_NAME }}
          tag_name: ${{ env.TAG_NAME }}
          body: |
            ğŸš€ **AdGuard Rules List Update**
            
            **ğŸ“Š Statistics:**
            - ğŸ“¥ Total Sources: ${{ env.TOTAL_COUNT }}
            - âœ… Successful Downloads: ${{ env.SUCCESS_COUNT }}
            - âŒ Failed Downloads: ${{ env.FAILED_COUNT }}
            - ğŸ“ Total Rules: ${{ env.RULES_COUNT }}
            - ğŸ•’ Generated: ${{ env.BUILD_TIME }}
            
            **ğŸ“ Files:**
            - `output.txt` - Main rules file
            - `adguard-rules.txt` - Alternative filename
            
            **ğŸ”— Usage:**
            ```
            https://github.com/${{ github.repository }}/releases/latest/download/output.txt
            ```
            
            Or via CDN:
            ```
            https://cdn.jsdelivr.net/gh/${{ github.repository }}@release/output.txt
            ```
          draft: false
          prerelease: false
          files: |
            ./publish/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release branch
        run: |
          set -e
          
          echo "ğŸŒ¿ æ›´æ–° release åˆ†æ”¯..."
          
          cd publish
          git init
          git config --local user.name "github-actions[bot]"
          git config --local user.email "121651775+github-actions[bot]@users.noreply.github.com"
          git checkout -b release
          git add .
          git commit -m "ğŸš€ ${{ env.RELEASE_NAME }}

          ğŸ“Š Statistics:
          - Sources: ${{ env.SUCCESS_COUNT }}/${{ env.TOTAL_COUNT }}
          - Rules: ${{ env.RULES_COUNT }}
          - Generated: ${{ env.BUILD_TIME }}"
          
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f -u origin release
          
          echo "âœ… Release åˆ†æ”¯æ›´æ–°å®Œæˆ"

      - name: Purge CDN cache
        run: |
          echo "ğŸ”„ æ¸…ç† CDN ç¼“å­˜..."
          
          urls=(
            "https://purge.jsdelivr.net/gh/${{ github.repository }}@release/output.txt"
            "https://purge.jsdelivr.net/gh/${{ github.repository }}@release/adguard-rules.txt"
          )
          
          for url in "${urls[@]}"; do
            echo "æ¸…ç†: $url"
            curl -sS "$url" || echo "æ¸…ç†å¤±è´¥: $url"
          done
          
          echo "âœ… CDN ç¼“å­˜æ¸…ç†å®Œæˆ"

      - name: Update repository
        run: |
          set -e
          
          echo "ğŸ“ æ›´æ–°ä»“åº“æ–‡ä»¶..."
          
          # æ›´æ–°æ—¥å¿—
          echo "$(date '+%Y-%m-%d %H:%M:%S') - Rules: ${{ env.RULES_COUNT }}, Sources: ${{ env.SUCCESS_COUNT }}/${{ env.TOTAL_COUNT }}" >> ./rules/date.log
          
          # é…ç½® Git
          git config --global user.email "121651775+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # æäº¤æ›´æ”¹
          git add ./rules/output* ./rules/date.log
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "ğŸ“Š ${{ env.RELEASE_NAME }}

            - Rules: ${{ env.RULES_COUNT }}
            - Sources: ${{ env.SUCCESS_COUNT }}/${{ env.TOTAL_COUNT }}
            - Failed: ${{ env.FAILED_COUNT }}
            - Size: $(wc -c < rules/output.txt) bytes"
            
            git push
            echo "âœ… ä»“åº“æ›´æ–°å®Œæˆ"
          fi

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf temp_downloads merged_rules.txt temp_rules.txt
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: Summary
        if: always()
        run: |
          echo "ğŸ“‹ === æ„å»ºæ€»ç»“ ==="
          echo "ğŸ•’ æ„å»ºæ—¶é—´: ${{ env.BUILD_TIME }}"
          echo "ğŸ“Š è§„åˆ™æºæ€»æ•°: ${{ env.TOTAL_COUNT }}"
          echo "âœ… æˆåŠŸä¸‹è½½: ${{ env.SUCCESS_COUNT }}"
          echo "âŒ ä¸‹è½½å¤±è´¥: ${{ env.FAILED_COUNT }}"
          echo "ğŸ“ ç”Ÿæˆè§„åˆ™: ${{ env.RULES_COUNT }}"
          echo "ğŸ·ï¸  å‘å¸ƒæ ‡ç­¾: ${{ env.TAG_NAME }}"
          echo "=================="
