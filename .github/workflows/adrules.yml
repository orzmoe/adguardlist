name: sync-adrules

on:
  workflow_dispatch:
  watch:
    types: [started]
  schedule:
    - cron: "21 */3 * * *" # æ¯3å°æ—¶è¿è¡Œä¸€æ¬¡
  push:
    paths:
      - "setting/rules.txt" # å½“è§„åˆ™æºæ–‡ä»¶æ›´æ–°æ—¶è‡ªåŠ¨è¿è¡Œ
      - "main.go" # å½“ Go ä»£ç æ›´æ–°æ—¶è‡ªåŠ¨è¿è¡Œ

permissions:
  contents: write

env:
  TZ: Asia/Shanghai
  GOPROXY: https://proxy.golang.org,direct

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # è®¾ç½®è¶…æ—¶æ—¶é—´

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: go.sum

      - name: Setup Node.js & hostlist-compiler
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install hostlist-compiler
        run: npm install -g @adguard/hostlist-compiler@latest

      - name: Set environment variables
        run: |
          echo "RELEASE_NAME=Released on $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "TAG_NAME=$(date '+%Y%m%d%H%M')" >> $GITHUB_ENV
          echo "BUILD_TIME=$(date -Iseconds)" >> $GITHUB_ENV

      - name: Run Go rule generator
        run: go run main.go

      - name: Prepare release files
        run: |
          # Copy another version for alternate filename
          cp publish/output.txt publish/adguard-rules.txt
          echo "ğŸ“¦ å‘å¸ƒæ–‡ä»¶å‡†å¤‡å®Œæˆ"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ env.RELEASE_NAME }}
          tag_name: ${{ env.TAG_NAME }}
          body: |
            ğŸš€ **AdGuard Rules List Update**
            
            **ğŸ“Š Statistics:**
            - ğŸ“¥ Total Sources: ${{ env.TOTAL_COUNT }}
            - âœ… Successful Downloads: ${{ env.SUCCESS_COUNT }}
            - âŒ Failed Downloads: ${{ env.FAILED_COUNT }}
            - ğŸ“ Total Rules: ${{ env.RULES_COUNT }}
            - ğŸ•’ Generated: ${{ env.BUILD_TIME }}
            
            **ğŸ“ Files:**
            - `output.txt` - Main rules file
            - `adguard-rules.txt` - Alternative filename
            
            **ğŸ”— Usage:**
            ```
            https://github.com/${{ github.repository }}/releases/latest/download/output.txt
            ```
            
            Or via CDN:
            ```
            https://cdn.jsdelivr.net/gh/${{ github.repository }}@release/output.txt
            ```
          draft: false
          prerelease: false
          files: |
            ./publish/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release branch
        run: |
          echo "ğŸŒ¿ æ›´æ–° release åˆ†æ”¯..."
          
          cd publish
          git init
          git config --local user.name "github-actions[bot]"
          git config --local user.email "121651775+github-actions[bot]@users.noreply.github.com"
          git checkout -b release
          git add .
          git commit -m "ğŸš€ ${{ env.RELEASE_NAME }}

          ğŸ“Š Statistics:
          - Sources: ${{ env.SUCCESS_COUNT }}/${{ env.TOTAL_COUNT }}
          - Rules: ${{ env.RULES_COUNT }}
          - Generated: ${{ env.BUILD_TIME }}"
          
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f -u origin release
          
          echo "âœ… Release åˆ†æ”¯æ›´æ–°å®Œæˆ"

      - name: Purge CDN cache
        run: |
          echo "ğŸ”„ æ¸…ç† CDN ç¼“å­˜..."
          
          urls=(
            "https://purge.jsdelivr.net/gh/${{ github.repository }}@release/output.txt"
            "https://purge.jsdelivr.net/gh/${{ github.repository }}@release/adguard-rules.txt"
          )
          
          for url in "${urls[@]}"; do
            echo "æ¸…ç†: $url"
            curl -sS "$url" || echo "æ¸…ç†å¤±è´¥: $url"
          done
          
          echo "âœ… CDN ç¼“å­˜æ¸…ç†å®Œæˆ"

      - name: Update repository
        run: |
          echo "ğŸ“ æ›´æ–°ä»“åº“æ–‡ä»¶..."
          
          # æ›´æ–°æ—¥å¿—
          echo "$(date '+%Y-%m-%d %H:%M:%S') - Rules: ${{ env.RULES_COUNT }}, Sources: ${{ env.SUCCESS_COUNT }}/${{ env.TOTAL_COUNT }}" >> ./rules/date.log
          
          # é…ç½® Git
          git config --global user.email "121651775+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # æäº¤æ›´æ”¹
          git add ./rules/output* ./rules/date.log
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "ğŸ“Š ${{ env.RELEASE_NAME }}

            - Rules: ${{ env.RULES_COUNT }}
            - Sources: ${{ env.SUCCESS_COUNT }}/${{ env.TOTAL_COUNT }}
            - Failed: ${{ env.FAILED_COUNT }}
            - Size: $(stat -c%s rules/output.txt) bytes"
            
            git push
            echo "âœ… ä»“åº“æ›´æ–°å®Œæˆ"
          fi

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -f merged_rules.txt compiled_rules.txt
          echo "âœ… æ¸…ç†å®Œæˆ"
